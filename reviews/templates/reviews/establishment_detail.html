{% extends "reviews/base.html" %}
{% load static %} {# Pour charger les images statiques #}

{% block title %}Détails de l'Établissement - {{ establishment.nom_r }}{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-lg rounded">
        <div class="card-body">
            <!-- 🏠 Informations sur l'établissement -->
            <h1 class="card-title text-center">{{ establishment.nom_r }}</h1>
            <p><strong>📍 Adresse :</strong> {{ establishment.addresse }}</p>
            <p><strong>📝 Description :</strong> {{ establishment.description }}</p>

            <!-- 🍽 Section Menu -->
            <h2 class="mt-4">🍽 Menu</h2>

            {% if menus %}
                <div class="row">
                    {% for menu in menus %}
                        <div class="col-md-4 mb-4">
                            <div class="card shadow-sm">
                                {% if menu.image %}
                                    <img src="{{ menu.image.url }}" class="card-img-top" alt="{{ menu.nom_plat }}">
                                {% elif menu.menu_pdf %}
                                    <div class="card-body">
                                        <p class="text-primary"><strong>💰 Prix :</strong> {{ menu.prix }} FCFA</p>
                                        <a href="{{ menu.menu_pdf.url }}" class="btn btn-info" target="_blank">📄 Voir le PDF</a>
                                    </div>
                                {% endif %}
                                <div class="card-body">
                                    {% if menu.nom_plat %}
                                        <h5 class="card-title">{{ menu.nom_plat }}</h5>
                                    {% endif %}
                                    {% if menu.description %}
                                        <p class="card-text">{{ menu.description|truncatechars:100 }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Aucun menu disponible pour cet établissement.</p>
            {% endif %}
            

            <!-- 🔙 Boutons d'action -->
            <div class="mt-4 d-flex flex-wrap gap-2">
                <a href="{% url 'home' %}" class="btn btn-primary">🏠 Retour à l'Accueil</a>
                <a href="{% url 'add_review' establishment.id %}" class="btn btn-success">➕ Ajouter un Avis</a>
            </div>

            <!-- ⭐ Section des Avis -->
            <h2 class="mt-4">Avis des utilisateurs</h2>

            {% if establishment.reviews.exists %}
                <ul class="list-group mt-3">
                    {% for review in establishment.reviews.all %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <strong>{{ review.utilisateur.username }}</strong>
                                <small class="text-muted">{{ review.crée_le|date:"d M Y" }}</small>
                            </div>
                            <p class="mb-1">{{ review.commentaire }}</p>
                            <p class="text-warning">
                                {% for _ in "⭐"|ljust:review.note %}⭐{% endfor %}
                            </p>

                            <!-- 👍👎 Système de Vote -->
                            <div class="vote-buttons">
                                <button class="btn btn-success vote-btn" data-review-id="{{ review.id }}" data-vote-type="like">
                                    👍 <span id="like-count-{{ review.id }}">{{ review.total_likes }}</span>
                                </button>
                                <button class="btn btn-danger vote-btn" data-review-id="{{ review.id }}" data-vote-type="dislike">
                                    👎 <span id="dislike-count-{{ review.id }}">{{ review.total_dislikes }}</span>
                                </button>

                                <!-- 🚨 Bouton Signaler (uniquement si l'utilisateur est connecté et n'est pas l'auteur de l'avis) -->
                                {% if user.is_authenticated and user != review.utilisateur %}
                                    <button class="btn btn-warning report-btn" data-review-id="{{ review.id }}">
                                        🚨 Signaler (<span id="report-count-{{ review.id }}">{{ review.total_reports }}</span>)
                                    </button>
                                {% endif %}
                            </div>

                            <!-- ✏️ Actions sur l'avis (modifier/supprimer) -->
                            {% if request.user.is_authenticated and review.utilisateur == request.user %}
                                <div class="review-actions mt-2">
                                    <a href="{% url 'edit_review' review.id %}" class="btn btn-warning">Modifier</a>
                                    <a href="{% url 'delete_review' review.id %}" class="btn btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet avis ?');">Supprimer</a>
                                </div>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted mt-3">Aucun avis pour le moment. Soyez le premier à donner votre avis !</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- 🎯 Scripts JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    // Gestion du vote 👍👎
    document.querySelectorAll(".vote-btn").forEach(button => {
        button.addEventListener("click", function() {
            const reviewId = this.getAttribute("data-review-id");
            const voteType = this.getAttribute("data-vote-type");

            fetch(`/review/${reviewId}/vote/${voteType}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                credentials: "same-origin"
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById(`like-count-${reviewId}`).textContent = data.likes;
                document.getElementById(`dislike-count-${reviewId}`).textContent = data.dislikes;
            })
            .catch(error => console.error("Erreur:", error));
        });
    });

    // Gestion du signalement 🚨
    document.querySelectorAll(".report-btn").forEach(button => {
        button.addEventListener("click", function() {
            const reviewId = this.getAttribute("data-review-id");

            fetch(`/review/${reviewId}/report/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                credentials: "same-origin"
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert(data.error);
                } else {
                    document.getElementById(`report-count-${reviewId}`).textContent = data.total_reports;
                    alert(data.message);
                }
            })
            .catch(error => console.error("Erreur:", error));
        });
    });
});
</script>

{% endblock %}
